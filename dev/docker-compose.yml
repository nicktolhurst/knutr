#===============================================================================
# Knutr Development Stack
#===============================================================================
# Basic:    docker compose up -d
# + GitLab: docker compose --profile gitlab up -d
#
# Access services via (default port 8443, or 443 if available):
#   https://traefik.knutr.local:8443   - Traefik dashboard
#   https://grafana.knutr.local:8443   - Grafana (admin/admin)
#   https://prometheus.knutr.local:8443 - Prometheus
#   https://tempo.knutr.local:8443     - Tempo
#   https://ollama.knutr.local:8443    - Ollama API
#   https://gitlab.knutr.local:8443    - GitLab CE (with --profile gitlab)
#
# To use standard ports (80/443), set in .env:
#   TRAEFIK_HTTP_PORT=80
#   TRAEFIK_HTTPS_PORT=443
#
# Run ./setup.sh or .\setup.ps1 to configure hosts file and SSL certs
#===============================================================================

networks:
  knutr-network:
    name: knutr-network
    driver: bridge

services:
  #-----------------------------------------------------------------------------
  # Traefik - Reverse Proxy
  #-----------------------------------------------------------------------------
  traefik:
    image: traefik:v3.0
    container_name: knutr-traefik
    restart: unless-stopped
    command:
      # EntryPoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"

      # Attach the static configuration tls.yaml file that contains the tls configuration settings
      - "--providers.file.filename=/dynamic/tls.yml"

      # Providers 
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=knutr-network"

      # API & Dashboard 
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Observability 
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--metrics.prometheus=true"
    networks:
      knutr-network:
        aliases:
          - traefik
          - gitlab.knutr.local
    ports:
      - "${TRAEFIK_HTTP_PORT:-8880}:80"
      - "${TRAEFIK_HTTPS_PORT:-8443}:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic:/dynamic:ro
      - ./certs:/certs:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.knutr.local`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"

  #-----------------------------------------------------------------------------
  # Monitoring Stack
  #-----------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: knutr-prometheus
    networks:
      - knutr-network
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.knutr.local`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  tempo:
    image: grafana/tempo:latest
    container_name: knutr-tempo
    networks:
      - knutr-network
    volumes:
      - ./tempo.yml:/etc/tempo.yml:ro
    command: ["-config.file=/etc/tempo.yml"]
    ports:
      - "4317:4317"   # OTLP gRPC ingest (keep exposed for app)
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tempo.rule=Host(`tempo.knutr.local`)"
      - "traefik.http.routers.tempo.entrypoints=websecure"
      - "traefik.http.routers.tempo.tls=true"
      - "traefik.http.services.tempo.loadbalancer.server.port=3200"

  grafana:
    image: grafana/grafana:latest
    container_name: knutr-grafana
    networks:
      - knutr-network
    depends_on: [prometheus, tempo]
    volumes:
      - ./grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SERVER_ROOT_URL=https://grafana.knutr.local
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.knutr.local`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  #-----------------------------------------------------------------------------
  # ngrok - Tunnel for Slack webhooks
  #-----------------------------------------------------------------------------
  ngrok:
    image: ngrok/ngrok:latest
    container_name: knutr-ngrok
    networks:
      - knutr-network
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    command:
      - "http"
      - "--domain=${NGROK_DOMAIN}"
      - "host.docker.internal:7071"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ngrok.rule=Host(`ngrok.knutr.local`)"
      - "traefik.http.routers.ngrok.entrypoints=websecure"
      - "traefik.http.routers.ngrok.tls=true"
      - "traefik.http.services.ngrok.loadbalancer.server.port=4040"

  #-----------------------------------------------------------------------------
  # Ollama - Local LLM
  #-----------------------------------------------------------------------------
  ollama:
    image: ${OLLAMA_IMAGE:-ollama/ollama:latest}
    container_name: knutr-ollama
    networks:
      - knutr-network
    restart: unless-stopped
    ports:
      - "11434:11434"   # Keep exposed for app direct access
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    volumes:
      - ollama:/root/.ollama
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.knutr.local`)"
      - "traefik.http.routers.ollama.entrypoints=websecure"
      - "traefik.http.routers.ollama.tls=true"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"

  #-----------------------------------------------------------------------------
  # GitLab CE - Optional (use --profile gitlab to include)
  # Heavy container: ~4GB RAM, takes 3-5 minutes to start
  #-----------------------------------------------------------------------------
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: knutr-gitlab
    profiles:
      - gitlab
    networks:
      - knutr-network
    hostname: gitlab.knutr.local
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.knutr.local'
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
        nginx['proxy_set_headers'] = {
          "X-Forwarded-Proto" => "https",
          "X-Forwarded-Ssl" => "on"
        }
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        # Reduce memory usage for development
        puma['worker_processes'] = 2
        sidekiq['max_concurrency'] = 5
        prometheus_monitoring['enable'] = false
        # Disable features not needed for testing
        gitlab_rails['gitlab_default_can_create_group'] = true
        gitlab_rails['gitlab_username_changing_enabled'] = true
    ports:
      - "2222:22"        # SSH for git
    shm_size: '256m'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=Host(`gitlab.knutr.local`)"
      - "traefik.http.routers.gitlab.entrypoints=websecure"
      - "traefik.http.routers.gitlab.tls=true"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80"

  #-----------------------------------------------------------------------------
  # GitLab Runner - Optional (use --profile gitlab to include)
  #-----------------------------------------------------------------------------
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: knutr-gitlab-runner
    profiles:
      - gitlab
    networks:
      - knutr-network
    restart: unless-stopped
    depends_on:
      - gitlab
    volumes:
      - gitlab_runner_config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - CI_SERVER_URL=http://gitlab
      - CLONE_URL=http://gitlab

volumes:
  ollama:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_runner_config:
